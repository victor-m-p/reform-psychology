---
title: "Untitled"
output: html_document
---

# if first session on Ucloud

```{r, include=FALSE}

# consider pacman
install.packages("pacman") 
library(pacman)

p_load(tidyverse, brms, ggthemes, bayesplot, cowplot)

# set up cmdstanr 
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)

# get fun helper
setwd("/work/50114/MAG/modeling/code")
source("fun_helper.R")

```

# load data

```{r}

# check data
d <- read_csv("/work/50114/MAG/data/modeling/psych_replication_matched.csv") %>%
  mutate(log_teamsize = log(n_authors), 
         condition_coded = ifelse(condition == "experiment", 1, 0),
         condition_fct = as_factor(condition), 
         teamsize_scaled = (n_authors-min(n_authors))/(max(n_authors)-min(n_authors)),
         days_after_2010_scaled = days_after_2010/max(days_after_2010),
         id_fct = as_factor(PaperId)) %>% # because min = 0
  glimpse()

```

## straight to main model (no random slopes yet though) ##

```{r}

# just simple model here
## should teamsize also be a main effect?
f_team = bf(c_5 ~ 0 + condition_fct + condition_fct:teamsize_scaled)

```

# get priors for zero-inflated poisson and negative binomial 
# priors losely based on defaults & recoded (but could need more thouhgt). 

## zero-inflated poisson (ZIP):
class = b, 
class = zi 

## negative binomial (NB):
class = b,
class = gamma

## zero-inflated negative binomial: 
class = b,
class = zi, 
class = gamma 

## for the random intercept we also need class = sd 

```{r}

get_prior(
  formula = f_team,
  data = d,
  family = zero_inflated_poisson(),
)

get_prior(
  formula = f_team, 
  data = d, 
  family = negbinomial()
)

get_prior(
  formula = f_team,
  data = d,
  family = zero_inflated_negbinomial()
)


```

# function for fitting models 

```{r}

fit_model <- function(family, formula, prior, sample_prior, file, random_seed = 13){ 
  
  m <- brm(data = d, 
           family = family, 
           formula = formula,
           prior = prior, 
           sample_prior = sample_prior,
           cores = 4,
           chains = 2,
           iter = 4000, 
           warmup = 2000,
           file = file,
           file_refit = "on_change",
           threads = threading(2),
           seed = random_seed,
           control = list(adapt_delta = .99, 
                          max_treedepth = 20), 
           backend = "cmdstanr")
  
  if (sample_prior == TRUE){
    
    m <- add_criterion(m, 
                   c("loo", "waic", "bayes_R2"),
                   file = file,
                   force_save = TRUE)
  }

  return(m)
  
  }
  
```

# sample only prior

```{r, include=FALSE}

## ZIP models 

zip_prior <- c(prior(beta(2, 2), class = zi), # the brms default is beta(1, 1)
                    prior(normal(0, 1), class = b))

zip_team <- fit_model(
  family = zero_inflated_poisson(), 
  formula = f_team,
  prior = zip_prior,
  sample_prior = "only",
  file = "/work/50114/MAG/modeling/models/zip_prior"
)

## negative binomial models 
# 19 of 4000 (0.0%) transitions ended with a divergence (with stricter priors)

negbin_prior <- c(prior(gamma(0.01, 0.01), class = shape), # default
                  prior(normal(0, 1), class = b))

negbin_team <- fit_model(
  family = negbinomial(), 
  formula = f_team,
  prior = negbin_prior,
  sample_prior = "only",
  file = "/work/50114/MAG/modeling/models/negbin_prior"
)


## zero-inflated negative binomial models 
# 1 of 4000 (0.0%) transitions ended with a divergence (with stricter priors)

zinegbin_prior = c(prior(gamma(0.01, 0.01), class = shape),  # using the default
                prior(normal(0, 1), class = b),
                prior(beta(2, 2), class = zi))

zinegbin_team <- fit_model(
  family = zero_inflated_negbinomial(),
  formula = f_team,
  prior = zinegbin_prior,
  sample_prior = "only",
  file ="/work/50114/MAG/modeling/models/negbin_prior"
)

```

# fit models 

```{r}

zip_post <- fit_model(
  family = zero_inflated_poisson(), 
  formula = f_team,
  prior = zip_prior,
  sample_prior = TRUE,
  file = "/work/50114/MAG/modeling/models/zip_post"
)

negbin_post <- fit_model(
  family = negbinomial(), 
  formula = f_team,
  prior = negbin_prior,
  sample_prior = TRUE,
  file = "/work/50114/MAG/modeling/models/negbin_post"
)

zinegbin_post <- fit_model(
  family = zero_inflated_negbinomial(),
  formula = f_team,
  prior = zinegbin_prior,
  sample_prior = TRUE,
  file = "/work/50114/MAG/modeling/models/zinegbin_post"
)

```


