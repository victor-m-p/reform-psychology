---
title: "Untitled"
output: html_document
---

# if first session on Ucloud

```{r, include=FALSE}

# consider pacman
install.packages("pacman") 
library(pacman)

p_load(tidyverse, brms, ggthemes, bayesplot, cowplot)

# set up cmdstanr 
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)

```

# load data 

```{r}

# check data
d <- read_csv("/work/50114/MAG/data/modeling/psych_replication_matched.csv") %>%
  mutate(log_teamsize = log(n_authors), 
         condition_coded = ifelse(condition == "experiment", 1, 0),
         condition_fct = as_factor(condition), 
         teamsize_scaled = (n_authors-min(n_authors))/(max(n_authors)-min(n_authors)),
         days_after_2010_scaled = days_after_2010/max(days_after_2010),
         id_fct = as_factor(PaperId)) %>% # because min = 0
  glimpse()


```

# read models (from fit_likelihood.Rmd)

```{r}

zip_prior <- readRDS("models/zip_prior.rds")
zip_post <- readRDS("models/zip_post.rds")
negbin_prior <- readRDS("models/negbin_prior.rds")
negbin_post <- readRDS("models/negbin_post.rds")
zinegbin_prior <- readRDS("models/zinegbin_prior.rds")
zinegbin_post <- readRDS("models/zinegbin_post.rds")


```

# prior predictive checks 

```{r}

prior_check <- function(model, ndraws, title, xmax){
  
  pp_check(model, 
           ndraws = ndraws) +
    labs(title = title) + 
    theme_minimal() + 
    xlim(0, xmax)
  
} 

```

## ZIP prior

```{r}

prior_check(zip_prior, 100, "zip prior (x cutoff: 25)", 25)

```

## negative binomial prior

```{r}

prior_check(negbin_prior, 100, "negative binomial prior (x cutoff: 25)", 25)

```

## zero-inflated negative binomial prior 

```{r}
prior_check(zinegbin_prior, 100, "zero-inflated negative binomial prior (x cutoff: 25)", 25)
```

# check posterior sampling 
https://mc-stan.org/bayesplot/articles/graphical-ppcs.html

```{r}

y <- d$c_5
y_zip <- posterior_predict(zip_post, draws = 500)
y_negbin <- posterior_predict(negbin_post, draws = 500)
y_zinegbin <- posterior_predict(zinegbin_post, draws = 500)

```

# overlay & histogram

## ZIP
we see the key issue again here... 
we have two distributions which is not reflective of the actual data. 

```{r}

ppc_dens_overlay(y, y_zip[1:50, ]) + xlim(0, 50)
ppc_hist(y, y_zip[1:5, ]) + xlim(-1, 50)


```

## negbin  
looks really good. 
has a hard time figuring out the correct number of 0s. 

```{r}

ppc_dens_overlay(y, y_negbin[1:50, ]) + xlim(01, 50)
ppc_hist(y, y_negbin[1:5, ]) + xlim(-1, 50)


```

## zinegbin  
looks really good. 
very similar to negbin.

```{r}

ppc_dens_overlay(y, y_zinegbin[1:50, ]) + xlim(-1, 50)
ppc_hist(y, y_zinegbin[1:5, ]) + xlim(-1, 50)

```

