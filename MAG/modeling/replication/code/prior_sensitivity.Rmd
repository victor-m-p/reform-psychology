---
title: "Prior Robustness"
author: "Victor M. Poulsen" 
output: html_document
---

```{r setup, include=FALSE}

# consider pacman
install.packages("pacman") 
library(pacman)

p_load(tidyverse, brms, ggthemes, bayesplot, cowplot, tidybayes, modelr)

# set up cmdstanr if it is not already present
if (!require('cmdstanr')){
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)
}

setwd("/work/50114/MAG/modeling/replication/code")
source("fun_helper.R")

```

# read data and create some variables
## (1) temsize log. 
## (2) match group as id 

```{r}

# check data
d <- read_csv("/work/50114/MAG/data/modeling/psychology_replicat_matched.csv") %>%
  mutate(log_teamsize = log(n_authors), 
         condition_fct = as_factor(condition), 
         id_match = as_factor(match_group),
         id_dct = as_factor(PaperId),
         year_after_2005 = Year - 2005) %>% 
  glimpse()

```

# model formula 

```{r}

f <- bf(c_5 ~ 0 + condition_fct + condition_fct:log_teamsize + condition_fct:year_after_2005 + (0 + condition_fct | id_match))

```

# get prior:
* b: effects.
* cor: correlation of random effecs I think
* sd: match and both conditions.
* shape: overdispersion parameter for negative binomial.

```{r}

get_prior(
  formula = f,
  data = d, 
  family = negbinomial())

```

# how to set priors (help)

```{r}

d %>% filter(n_authors == 1) %>%
  summarize(mean = mean(c_5))

```

# prior for main model

```{r}

# informed by prior-posterior update
p <- c(prior(exponential(0.5), class = shape), # overdispersion parameter
       prior(normal(log(8), 0.5), class = b, coef = "condition_fctcontrol"),
       prior(normal(log(8), 0.5), class = b, coef = "condition_fctexperiment"),
       prior(normal(0.5, 0.5), class = b, coef = "condition_fctcontrol:log_teamsize"),
       prior(normal(0.5, 0.5), class = b, coef = "condition_fctexperiment:log_teamsize"),
       prior(normal(0, 0.5), class = b, coef = "condition_fctcontrol:year_after_2005"),
       prior(normal(0, 0.5), class = b, coef = "condition_fctexperiment:year_after_200"),
       prior(exponential(1), class = sd),
       prior(lkj(5), class = cor)) # Solomon Kurz (less flat). 

```

# initialize vars 

```{r}

# initialize lists
int_ci_lower <- c()
int_ci_upper <- c()
int_ci_est <- c()
team_ci_lower <- c()
team_ci_upper <- c()
team_ci_est <- c()
year_ci_lower <- c()
year_ci_upper <- c()
year_ci_est <- c()

# set outpath 
outpath = '/work/50114/MAG/modeling/replication/models/prior_sensitivity/m_post_' 

# prior sequence
priSD <- seq(0.1, 1.5, length.out = 15)

```

# run everything 

```{r}

for (i in 1:length(priSD)){
  
  p[2,] <- set_prior(paste0("normal(log(8), ", priSD[i],")"), 
                     class = "b",
                     coef = "condition_fctcontrol")
  p[3,] <- set_prior(paste0("normal(log(8), ", priSD[i],")"), 
                     class = "b",
                     coef = "condition_fctexperiment")
  p[4,] <- set_prior(paste0("normal(0.5, ", priSD[i],")"),
                     class = "b",
                     coef = "condition_fctcontrol:log_teamsize")
  p[5,] <- set_prior(paste0("normal(0.5, ", priSD[i],")"),
                     class = "b",
                     coef = "condition_fctexperiment:log_teamsize")
  p[6,] <- set_prior(paste0("normal(0, ", priSD[i],")"),
                     class = "b",
                     coef = "condition_fctcontrol:year_after_2005")
  p[7,] <- set_prior(paste0("normal(0, ", priSD[i],")"),
                     class = "b",
                     coef = "condition_fctexperiment:year_after_2005")
  
  # get path / name for saving 
  model_name <- paste0(outpath, priSD[i]) 
  
  # fit model 
  m_post <- fit_model(
    family = negbinomial(), 
    formula = f, 
    prior = p,
    sample_prior = TRUE,
    file = model_name
  )
  
  # get difference through hypothesis
  h_intercept <- hypothesis(
    m_post, 
    "condition_fctexperiment < condition_fctcontrol", 
    alpha = 0.05)
  
  h_teamsize <- hypothesis(
    m_post, 
    "condition_fctexperiment:log_teamsize < condition_fctcontrol:log_teamsize",
    alpha = 0.05
  )
  
  h_year <- hypothesis(
    m_post, "condition_fctexperiment:year_after_2005 <
    condition_fctcontrol:year_after_2005",
    alpha = 0.05
  )
  
  
  # get out estimates & add to lists
  int_ci_lower[i] <- h_intercept$hypothesis$CI.Lower
  int_ci_upper[i] <- h_intercept$hypothesis$CI.Upper
  int_ci_est[i] <- h_intercept$hypothesis$Estimate
  team_ci_lower[i] <- h_teamsize$hypothesis$CI.Lower 
  team_ci_upper[i] <- h_teamsize$hypothesis$CI.Upper
  team_ci_est[i] <- h_teamsize$hypothesis$Estimate
  year_ci_lower[i] <- h_year$hypothesis$CI.Lower
  year_ci_upper[i] <- h_year$hypothesis$CI.Upper
  year_ci_est[i] <- h_year$hypothesis$Estimate

}

```

# plot results 

```{r}

color_scheme_set("orange")
theme_set(theme_classic())
outpath = "/work/50114/MAG/fig/modeling/replication/prior_sensitivity/"

```

## intercept difference

```{r}

# get data 
int_data <- tibble(priSD, int_ci_lower, int_ci_upper, int_ci_est) 

# plot 
p <- int_data %>% ggplot(aes(x = priSO, y = int_ci_est)) + 
  geom_point(size = 3) + 
  geom_pointrange(ymin = team_ci_lower, ymax = team_ci_upper) + 
  ylim(-0.5, 1.5) +
  labs(x="Standard deviation of intercept prior",
       y="Posterior estimate of intercept difference", 
       title="Sensitivity analysis (intercept)") +
  theme(plot.title = element_text(hjust = 0.5))

# save 
outname = paste0(outpath, "intercept.pdf")
ggsave(filename = outname, plot = p)

```

## teamsize interaction difference

```{r}

# get data 
team_data <- tibble(priSD, team_ci_lower, team_ci_upper, team_ci_est)

# plot 
p <- team_data %>% ggplot(aes(x = priSD, y = team_ci_est)) + 
  geom_point(size = 3) + 
  geom_pointrange(ymin = team_ci_lower, ymax = team_ci_upper) + 
  ylim(-0.5, 0.25) +
  labs(x="Standard deviation of interaction prior",
       y="Posterior estimate for interaction difference", 
       title="Sensitivity analysis (teamsize)") + 
  theme(plot.title = element_text(hjust = 0.5))

# save 
outname = paste0(outpath, "teamsize.pdf")
ggsave(filename = outname, plot = p)

```

## year interaction difference

```{r}

# get data
year_data <- tibble(priSD, year_ci_lower, year_ci_upper, year_ci_est)

# plot 
year_data %>% ggplot(aes(x = priSD, y = year_ci_est)) + 
  geom_point(size = 3) + 
  geom_pointrange(ymin = year_ci_lower, ymax = year_ci_upper) + 
  ylim(-0.5, 0.25) +
  labs(x="Standard deviation of interaction prior",
       y="Posterior estimate for interaction difference", 
       title="Sensitivity analysis (year after 2005)") + 
  theme(plot.title = element_text(hjust = 0.5))

# save 
outname = paste0(outpath, "year.pdf")
ggsave(filename = outname, plot = p)

```

