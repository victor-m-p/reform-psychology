---
title: "Likelihood Comparison"
author: "Victor M. Poulsen" 
output: html_document
---

# VMP 2022-03-09: should be done now. 

## path setup

```{r}

inpath_csv = "/work/50114/MAG/data/modeling/psychology_replication_matched.csv"
wd_code = "/work/50114/MAG/modeling/replication_fos/code"
outpath_models = "/work/50114/MAG/modeling/replication_fos/models/likelihood_comparison/"
outpath_plots = '/work/50114/MAG/fig/modeling/replication_fos/likelihood_comparison/'

```

## packages & libraries

```{r setup, include=FALSE}
# consider pacman
install.packages("pacman") 
library(pacman)

p_load(tidyverse, brms, ggthemes, bayesplot, cowplot, tidybayes, modelr)

# set up cmdstanr if it is not already present
if (!require('cmdstanr')){
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)
}

setwd(wd_code)
source("fun_helper.R")
```

## visual setup

consider (a) text-size and (b) width/height

```{r}

# text size: 
# https://statisticsglobe.com/change-font-size-of-ggplot2-plot-in-r-axis-text-main-title-legend

# ggsave: 
# https://ggplot2.tidyverse.org/reference/ggsave.html

color_scheme_set("orange")
theme_set(theme_classic())
title = 18
label = 14
tick = 12

```


# read data and create some variables
## (1) temsize log. 
## (2) match group as id 

```{r}

# check data
d <- read_csv(inpath_csv) %>%
  mutate(log_teamsize = log(n_authors), 
         condition_fct = as_factor(condition), 
         id_match = as_factor(match_group),
         id_dct = as_factor(PaperId),
         year_after_2005 = Year - 2005) %>% 
  glimpse()

```

# define model

```{r}

f <- bf(c_5 ~ 0 + condition_fct + condition_fct:log_teamsize + condition_fct:year_after_2005 + (0 + condition_fct | id_match))

```

# get priors 

## zero-inflated poisson: 
b, cor, sd, zi

## negative binomial: 
b, cor, sd, shape 

## zero-inflated negative binomial: 
b, cor, sd, shape, zi 


```{r}

get_prior(
  formula = f, 
  data = d, 
  family = negbinomial()
)

get_prior(
  formula = f,
  data = d,
  family = zero_inflated_poisson(),
)

get_prior(
  formula = f,
  data = d,
  family = zero_inflated_negbinomial()
)

```


# define priors 

```{r}

## prior negative binomial (also the priors for main model)
p_negbin <- c(prior(exponential(0.5), class = shape), # overdispersion parameter
              prior(normal(log(10), 0.5), class = b, coef = "condition_fctcontrol"),
              prior(normal(log(10), 0.5), class = b, coef = "condition_fctexperiment"),
              prior(normal(0.5, 0.5), coef = "condition_fctcontrol:log_teamsize"),
              prior(normal(0.5, 0.5), coef = "condition_fctexperiment:log_teamsize"),
              prior(normal(0, 0.5), class = b),
              prior(exponential(1), class = sd),
              prior(lkj(5), class = cor)) # Solomon Kurz (less flat). 

## prior zero-inflated poisson
p_zip <- c(prior(beta(2, 2), class = zi), # overdispersion parameter
           prior(normal(log(10), 0.5), class = b, coef = "condition_fctcontrol"),
           prior(normal(log(10), 0.5), class = b, coef = "condition_fctexperiment"),
           prior(normal(0.5, 0.5), coef = "condition_fctcontrol:log_teamsize"),
           prior(normal(0.5, 0.5), coef = "condition_fctexperiment:log_teamsize"),
           prior(normal(0, 0.5), class = b),
           prior(exponential(1), class = sd),
           prior(lkj(5), class = cor)) # Solomon Kurz (less flat). 

## prior zero-inflated negative binomial
p_zinegbin <- c(prior(exponential(0.5), class = shape), # overdispersion parameter
                prior(beta(2, 2), class = zi),
                prior(normal(log(10), 0.5), class = b, coef = "condition_fctcontrol"),
                prior(normal(log(10), 0.5), class = b, coef = "condition_fctexperiment"),
                prior(normal(0.5, 0.5), coef = "condition_fctcontrol:log_teamsize"),
                prior(normal(0.5, 0.5), coef = "condition_fctexperiment:log_teamsize"),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sd),
                prior(lkj(5), class = cor)) # Solomon Kurz (less flat). 

```

# sample prior (NB: reproducibility with seed from fun_helper.R)


```{r}

## sample prior for negative binomial (no divergences)
m_prior_negbin <- fit_model(
  family = negbinomial(), 
  formula = f,
  prior = p_negbin,
  sample_prior = "only",
  file = paste0(outpath_models, "m_prior_negbin")
)

## sample prior for zero-inflated poisson (no divergences)
m_prior_zip <- fit_model(
  family = zero_inflated_poisson(),
  formula = f,
  prior = p_zip,
  sample_prior = "only",
  file = paste0(outpath_models, "m_prior_zip")
)

## sample prior for zero-inflated negative binomial (no divergences)
m_prior_zinegbin <- fit_model(
  family = zero_inflated_negbinomial(),
  formula = f,
  prior = p_zinegbin, 
  sample_prior = "only",
  file = paste0(outpath_models, "m_prior_zinegbin")
)

```

# sample posterior 

```{r}

## sample posterior for negative binomial (174 pareto_k > 0.7 & 136 (8.7%) p_waic > 0.4)
m_post_negbin <- fit_model(
  family = negbinomial(), 
  formula = f,
  prior = p_negbin,
  sample_prior = TRUE,
  file = paste0(outpath_models, "m_post_negbin")
)

## sample posterior for zero-inflated poisson (1086 pareto_k > 0.7 & 1222 (78.0%) p_waic > 0.4)
m_post_zip <- fit_model(
  family = zero_inflated_poisson(),
  formula = f,
  prior = p_zip,
  sample_prior = TRUE,
  file = paste0(outpath_models, "m_post_zip")
)

## sample posterior for zero-inflated negative binomial (405 pareto_k > 0.7 & 383 (24.5%) p_waic > 0.4)
m_post_zinegbin <- fit_model(
  family = zero_inflated_negbinomial(),
  formula = f,
  prior = p_zinegbin, 
  sample_prior = TRUE,
  file = paste0(outpath_models, "m_post_zinegbin")
)

```

# model diagnostics (pareto_k & p_waic)

```{r}

pareto_k <- function(d, m, likelihood){
  # d: dataframe 
  # m: model 
  # likelihood: string (for printing only)
  
  d_pareto <- d %>%
    mutate(k = m$criteria$loo$diagnostics$pareto_k) %>%
    filter(k > .7) %>%
    summarize(pareto_k = n()) 
  
  print(likelihood)
  print(d_pareto$pareto_k)
  
}

pareto_k(d, m_post_negbin, "pareto_k > 0.7 (negative binomial)") # 195
pareto_k(d, m_post_zip, "pareto_k > 0.7 (zero-inflated poisson)") # 1086
pareto_k(d, m_post_zinegbin, "pareto_k > 0.7 (zero-inflated negative binomial)") # 447

```

# chains, convergence & rhat 
## chains 

```{r}

# consider width and height
save_chains <- function(fit, path){
  pdf(path, height = 11, width = 8.5, paper = 'letter', onefile = FALSE) # half page
  plot(fit,
       variable = '^b',
       regex = TRUE,
       N = 10) # testing this. 
  dev.off()
}

```

```{r}

## save chains 
save_chains(fit = m_post_negbin, 
            path = paste0(outpath_plots, "chains_negbin.pdf"))

save_chains(fit = m_post_zip, 
            path = paste0(outpath_plots, "chains_zip.pdf"))

save_chains(fit = m_post_zinegbin,
            path = paste0(outpath_plots, "chains_zinegbin.pdf"))

```


## rhat 

```{r}

# all Rhat < 1.05
# all Bulk_ESS and Tail_ESS > 200
print(m_post_negbin)

```

```{r}

# some Rhat > 1.05
# some Bulk_ESS and Tail_ESS < 200
print(m_post_zip)

```

```{r}

# some Rhat > 1.05
# some Bulk_ESS and Tail_ESS < 200
print(m_post_zinegbin)

```

# posterior predictive checks (bayesplot)

## get y and yrep data

```{r}

# y: actual data 
y <- d$c_5 

# yrep: draws from posterior predictive distributions
yrep_negbin <- posterior_predict(m_post_negbin) 
yrep_zip <- posterior_predict(m_post_zip)
yrep_zinegbin <- posterior_predict(m_post_zinegbin)

```

### define function

```{r}

# full density
plot_density_full <- function(y, 
                              yrep, 
                              n, 
                              title, 
                              outname, 
                              outpath, 
                              title_size, 
                              label_size, 
                              title_size){ # subtitle
  
  p <- ppc_dens_overlay(y, yrep[1:n, ]) +
    labs(title = title)
         #subtitle = subtitle) + 
    theme(plot.title = element_text(hjust = 0.5),
          #plot.subtitle = element_text(hjust = 0.5),
          axis.text = element_text(size = tick_size),
          axis.title = element_text(size = label_size),
          text = element_text(size = title_size))
  
  fileout <- paste0(outpath, outname)
  ggsave(filename = fileout, 
         plot = p,
         width = 11,
         height = 3.5)
  
}

# capped density
plot_density_capped <- function(y, 
                                yrep, 
                                n, 
                                lim, 
                                title, 
                                subtitle, 
                                outname, 
                                outpath,
                                title_size,
                                label_size,
                                tick_size){
  
  p <- ppc_dens_overlay(y, yrep[1:n, ]) +
  labs(title = title)
       #subtitle = subtitle) + 
    xlim(0, lim) + 
  theme(plot.title = element_text(hjust = 0.5),
        #plot.subtitle = element_text(hjust = 0.5),
        axis.text = element_text(size = tick_size),
        axis.title = element_text(size = label_size),
        text = element_text(size = title_size))
  
  fileout <- paste0(outpath, outname)
  ggsave(filename = fileout, 
         plot = p,
         width = 11,
         heigh = 3.5)
  
}

```

### run

```{r}

n = 50
lim = 100
outpath = '/work/50114/MAG/fig/modeling/replication/likelihood_comparison/'
title = 'Posterior predictive density'

plot_density_full(
  y, 
  yrep_negbin, 
  n = n,
  title = "Negative binomial",
  outname = 'ppc_dens_full_negbin.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
  )

plot_density_full(
  y,
  yrep_zip, 
  n = n,
  title = "Zero-inflated Poisson",
  outname = 'ppc_dens_full_zip.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
)

plot_density_full(
  y, 
  yrep_zinegbin,
  n = n,
  title = "Zero-inflated negative binomial",
  outname = 'ppc_dens_full_zinegbin.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
)

plot_density_capped(
  y,
  yrep_negbin,
  n = n,
  lim = lim,
  title = "Negative binomial",
  outname = 'ppc_dens_100_negbin.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
)

plot_density_capped(
  y,
  yrep_zip,
  n = n,
  lim = lim,
  title = "Zero-inflated Poisson",
  outname = 'ppc_dens_100_zip.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
)

plot_density_capped(
  y, 
  yrep_zinegbin,
  n = n,
  lim = lim,
  title = "Zero-inflated negative binomial",
  outname = 'ppc_dens_100_zinegbin.pdf',
  outpath = outpath_plots,
  title_size = title,
  label_size = label,
  tick_size = tick
)

```
