---
title: "Untitled"
output: html_document
---

# if first session on Ucloud

```{r, include=FALSE}

# consider pacman
install.packages('tidyverse')
install.packages('brms')
install.packages("ggthemes")
library(tidyverse)
library(brms)
library(ggthemes)

# set up cmdstanr 
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2)

# rethinking 
install.packages(c("coda","mvtnorm","devtools","loo","dagitty"))
devtools::install_github("rmcelreath/rethinking")
library(rethinking)

```

# if NOT first session on Ucloud

```{r}

library(tidyverse)
library(brms)
library(ggthemes)
library(rethinking)

```

## load data 

```{r}

d_psych <- read_csv("/work/50114/MAG/data/modeling/psych_replication_matched.csv")

```


# BRMS & rethinking (recoded) test-code 

## Poisson Regression (CH 10.2)

### mean = variance for Poisson 

```{r}

set.seed(10) # make the results reproducible

tibble(y = rbinom(1e5, 1000, 1/1000)) %>% 
  summarise(y_mean     = mean(y),
            y_variance = var(y)) %>%
  glimpse()

```

### check our data (var >> mean) so does not make sense to model with one parameter as Poisson (lambda)
### can this be fixed with transformation (e.g. log?)

```{r}

# subset data & check stats
# variance >> mean 
d_exp <- d_psych %>% 
  filter(condition == "experiment") %>%
  summarize(y_mean = mean(c_5),
            y_variance = var(c_5)) %>%
  glimpse()

```

### example 

```{r}

library(rethinking)
data(Kline)
d <- Kline
detach(package:rethinking, unload = T)
library(brms)
rm(Kline)

```

```{r}

d %>% glimpse()

```

### mutate stuff 

```{r}

d <- d %>%
  mutate(log_pop = log(population),
         contact_high = ifelse(contact == "high", 1, 0))

```

```{r}

# check whether total_tools has mean = variance
# also not even close, so how can he do Poisson?
# because of the other predictors?
d %>% 
  summarise(y_mean = mean(total_tools),
            y_variance = var(total_tools)) %>%
  glimpse()

```


### model 
default link for Poisson is log

```{r}

b10.10 <-
  brm(data = d, family = poisson,
      total_tools ~ 1 + log_pop + contact_high + contact_high:log_pop,
      prior = c(prior(normal(0, 100), class = Intercept),
                prior(normal(0, 1), class = b)),
      iter = 3000, warmup = 1000, chains = 4, cores = 4,
      seed = 10) 

```

```{r}
print(b10.10)
```

### correlation plot

```{r}
install.packages("psych")
library(psych)

post <-
  posterior_samples(b10.10)

post %>%
  select(-lp__) %>% 
  rename(b_interaction = `b_log_pop:contact_high`) %>%
  psych::lowerCor()

```

#### coefficient plot 

```{r}

install.packages("bayesplot")
library(bayesplot)

# we'll set a renewed color theme
color_scheme_set(c(wes_palette("Moonrise2")[2],
                   wes_palette("Moonrise2")[1], 
                   wes_palette("Moonrise2")[4], 
                   wes_palette("Moonrise2")[2], 
                   wes_palette("Moonrise2")[1], 
                   wes_palette("Moonrise2")[1]))

post %>%
  select(-lp__) %>% 
  rename(b_interaction = `b_log_pop:contact_high`) %>%

  mcmc_intervals(prob = .5, prob_outer = .95) +
  theme(axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0))

```

#### how plausible that high-contact island more tools than low-contact island (could do same for exp. vs. control)

```{r}

# why times 8? (check rethinking) 
post <-
  post %>%
  mutate(lambda_high = exp(b_Intercept + b_contact_high + (b_log_pop + `b_log_pop:contact_high`) * 8),
         lambda_low  = exp(b_Intercept + b_log_pop * 8)) %>% 
  mutate(diff        = lambda_high - lambda_low) 

post %>%
  summarise(sum = sum(diff > 0) / length(diff))

```

#### actual plot of diff
is this distribution over probability of superiority?

```{r}
install.packages("wesanderson")
library(wesanderson)

post %>%
  ggplot(aes(x = diff)) +
  geom_density(color = "transparent",
               fill = wes_palette("Moonrise2")[1]) +
  geom_vline(xintercept = 0, linetype = 2,
             color = wes_palette("Moonrise2")[2]) +
  scale_y_continuous(NULL, breaks = NULL) +
  labs(x = "lambda_high - lambda_low")

```

