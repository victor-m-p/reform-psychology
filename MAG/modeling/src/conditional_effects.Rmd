---
title: "Conditional Effects"
author: "Victor M. Poulsen"
output: html_document
---

---
title: "Simulate and Predict"
author: "Victor M. Poulsen" 
output: html_document
---


```{r setup, include=FALSE}

inpath_csv <- "/work/50114/MAG/data/modeling/"
infile <- "psychology_replication_matched.csv"
outpath <- "/work/50114/MAG/fig/modeling/replication_fos/simulate_predict/"
inpath_post <- "/work/50114/MAG/modeling/models/replication_fos/main_model/m_post.rds"

```

```{r}

# consider pacman
install.packages("pacman") 
library(pacman)

p_load(tidyverse, brms, ggthemes, bayesplot, cowplot, tidybayes, modelr, latex2exp, ggpubr)

# set up cmdstanr if it is not already present
if (!require('cmdstanr')){
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)
}

```

# Visual setup 

```{r}

color_scheme_set("orange")
theme_set(theme_classic())

theme_set(theme_classic())
title = 18
label = 14
tick = 12 # same as legend

color_map <- c("Control" = '#fdae6b', 
               "Experiment" = '#e6550d')

categories <- c("Control",
                "Experiment")

```

# Load data

```{r}

csv_path <- paste0(inpath, infile)

# check data
d <- read_csv(csv_path) %>%
  mutate(log_teamsize = log(n_authors), 
         condition_fct = as_factor(condition), 
         id_match = as_factor(match_group),
         id_dct = as_factor(PaperId),
         year_after_2005 = Year - 2005) %>% 
  glimpse()

```

# Load Model

```{r}

m_post <- readRDS(paste0(inpath_post))

```

# Conditional Effects (no random effects)
Extremely strong effects without random effects.
How does this work & what does this suggest?

```{r}

plot(conditional_effects(m_post))

```

## same with manual formatting & focus on log(Team Size) 

```{r}
# with draws 
d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            #id_match = id_match,
            year_after_2005 = mean(year_after_2005)) %>% # fixed year
  add_epred_draws(m_post, ndraws = 100, re_formula = NA) %>% # ignore random effects
  ggplot(aes(x = log_teamsize, y = c_5, color= ordered(condition_fct))) +
  geom_line(aes(y = .epred, group = paste(condition_fct, .draw)), alpha = 0.25) +
  geom_point(data = d) + 
  labs(title = "fitted draws (population estimate) for fixed year (mean) & ignore random effects")

```

# Conditional Effects (random effects)
Now the effects more or less disappear, which makes more sense given the output of the model. 

```{r}

plot(conditional_effects(m_post, re_formula = NULL))

```
