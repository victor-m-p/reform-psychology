---
title: "Simulate and Predict"
author: "Victor M. Poulsen" 
output: html_document
---


```{r setup, include=FALSE}

inpath <- "/work/50114/MAG/data/modeling/"
infile <- "psychology_replication_matched.csv"
outpath <- "/work/50114/MAG/fig/modeling/replication_fos/simulate_predict/"
inpath_post <- "/work/50114/MAG/modeling/models/replication_fos/main_model/m_post.rds"

```

```{r, include = FALSE}

# consider pacman
if (!require("pacman")){
  install.packages("pacman") # repos = "http://cran.r-project.org"
}

library(pacman)
p_load(tidyverse, brms, ggthemes, bayesplot, cowplot, tidybayes, modelr, latex2exp, ggpubr)

# set up cmdstanr if it is not already present
if (!require('cmdstanr')){
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan(cores = 2, overwrite = TRUE)
}

```

# Visual setup 

```{r}

color_scheme_set("orange")
theme_set(theme_classic())

theme_set(theme_classic())
title = 18
label = 14
tick = 12 # same as legend

color_map <- c("Control" = '#fdae6b', 
               "Experiment" = '#e6550d')

categories <- c("Control",
                "Experiment")

```

# Load data

```{r}

csv_path <- paste0(inpath, infile)

# check data
d <- read_csv(csv_path) %>%
  mutate(log_teamsize = log(n_authors), 
         condition_fct = as_factor(condition), 
         condition_fct = fct_relevel(condition_fct, c("experiment", "control")),
         id_match = as_factor(match_group),
         id_dct = as_factor(PaperId),
         year_after_2005 = Year - 2005) 

```

# Load Model

```{r}

m_post <- readRDS(paste0(inpath_post))

```

# Prediction

## generate simulated data

```{r}

base_id = 2000
levels <- nrow(d)/2
max_id = base_id + levels - 1

d_pred <- d %>% dplyr::select(condition_fct, log_teamsize, year_after_2005) %>%
  mutate(id_match = as_factor(rep(base_id:max_id, each = 2))) %>% # new ids 
  add_predicted_draws(m_post, allow_new_levels = T) # no cutoff

```

## power-scale plot

```{r}

library(scales) # to access break formatting functions

# adding very small number to avoid log(0). 
p <- d_pred %>% group_by(condition_fct, .prediction) %>% 
  # prepare
  summarize(count = n()) %>%
  mutate(prediction = .prediction,
         N = count) %>% 
  # plot 
  ggplot(aes(x = prediction, y = N)) + #, color = condition_fct)) + 
  geom_freqpoly(data = . %>% filter(condition_fct == "control"), 
                stat = 'identity',
                aes(color = categories[1])) + 
  geom_freqpoly(data = . %>% filter(condition_fct == "experiment"), 
                stat = 'identity',
                aes(color = categories[2])) + 
  geom_vline(xintercept = 10) + 
  geom_vline(xintercept = 100) +
  geom_vline(xintercept = 1000) +
  annotate("text", x = 15, y = 10000, label = TeX("$c_5 = 10$"), size = 4) + 
  annotate("text", x = 160, y = 10000, label = TeX("$c_5 = 100$"), size = 4) + 
  annotate("text", x = 1700, y = 10000, label = TeX("$c_5 = 1000$"), size = 4) + 
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  labs(title = "", # "Model Simulated Data",
       x = TeX("$c_5$"),
       y = "N") +
  scale_color_manual(
      breaks = categories, 
      values = color_map,
      guide = guide_legend(title = NULL)) +
  theme(plot.title = element_text(hjust = 0.5, size = title),
        axis.text = element_text(size = tick),
        axis.title = element_text(size = label),
        legend.text = element_text(size = tick),
        legend.position = "bottom") 

p

```


## save power plot

```{r}

ggsave(filename = paste0(outpath, "model_simulation_power.pdf"),
       plot = p,
       width = 8,
       height = 5.5)

```

# probability of hit

```{r}

# function
n_above <- function(d, cutoff){
  
  divisor = nrow(d)/2
  label = paste0("above_", cutoff)
  d_above <- d %>% 
    group_by(condition_fct) %>%
    filter(.prediction > cutoff) %>%
    summarize(count = n()) %>%
    mutate(
      percent_of_total = round((count / divisor)*100, 2),
      percent_of_above = round((count / sum(count))*100, 2),
      type = label)
  
  return(d_above)
  
}

# generate 
d_0 <- n_above(d_pred, 0) # visible
d_10 <- n_above(d_pred, 10) # ...
d_100 <- n_above(d_pred, 100) # hit
d_1000 <- n_above(d_pred, 1000) # ...

# bind 
d_summary <- bind_rows(d_0, 
                       d_10,
                       d_100,
                       d_1000)

# save
write_csv(d_summary, paste0(outpath, "d_summary.csv"))

```

## conditional means / counterfactuals ##
https://cran.r-project.org/web/packages/tidybayes/vignettes/tidy-brms.html

### NOTE: 
We should do it for minimum values instaed of mean values & 
then provide it with more uncertainty in SI. 

### functions

TEAMSIZE draws (Kruschke) mean study and min YEAR (2005).

EXPLANATION: 
Based on our fitted BETA values (population) we plot draws of the
expected value (mean). NB: this is still more robust than not including
random effects in the original model, because our population estimates
are also affected by the random effects which we have modeled. We keep
YEAR fixed at mean (year = 2010) and vary TEAMSIZE over a grid within
the observed values (min and max observed TEAMSIZE). As such, the model
returns expected values for levels of TEAMSIZE that are not observed 
(e.g. TEAMSIZE = 1.5) and in this sense it is a counter-factual plot. 


```{r}

draws_team_min <- function(d, ylim){
  
  # fitted means (draws for mean)
  d %>%
    group_by(condition_fct) %>%
    data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
              year_after_2005 = min(year_after_2005)) %>% # fixed year
    add_epred_draws(m_post, ndraws = 100, re_formula = NA) %>% # ignore random effects
    ggplot(aes(x = log_teamsize, y = c_5, color= ordered(condition_fct))) +
    geom_line(aes(y = .epred, group = paste(condition_fct, .draw)), alpha = 0.25) +
    geom_point(data = d) + 
    labs(title = "Expected Value (mean actor)") +
    ylim(0, ylim)
  
}

```

Same as above but with CI bands

```{r}

CI_team_min <- function(d, ylim){
  
  # fitted means (draws for mean)
  d %>%
    group_by(condition_fct) %>%
    data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
              year_after_2005 = min(year_after_2005)) %>% # fixed year
    add_epred_draws(m_post, re_formula = NA) %>% # ignore random effects
    ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    geom_jitter(data = d) + 
    labs(title = "Expected Value (mean actor)") +
    ylim(0, ylim)
  
}
```

TEAMSIZE draws (CI bands) mean study and observed YEARS (varies)

```{r}
d %>% glimpse()
```


```{r}

CI_team_vary <- function(d, ylim){
  
  # fitted means (draws for mean)
  d %>%
    group_by(condition_fct) %>%
    data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
              year_after_2005 = year_after_2005) %>% # fixed year
    add_epred_draws(m_post, re_formula = NA) %>% # ignore random effect
    ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    geom_jitter(data = d, alpha = 0.8) + 
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    labs(title = "", #  "Expected Value (mean actor)",
         x = "log(TEAMSIZE)",
         y = TeX("$c_5$")) +
    theme(plot.title = element_text(hjust = 0.5, size = title),
          axis.text = element_text(size = tick),
          axis.title = element_text(size = label),
          legend.text = element_text(size = tick),
          legend.position = "bottom") +
    scale_color_manual(
      values = c('#e6550d', '#fdae6b'),
      guide = guide_legend(title = NULL)) +
    scale_fill_manual(
      values = c('#e6550d', '#fdae6b'),
      guide = guide_legend(title = NULL)) +
    ylim(0, ylim)
  
}

```

```{r}
CI_team_vary(d, 500)
```
## test 

```{r}
d_test <- d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            year_after_2005 = year_after_2005) %>% # fixed year
  add_epred_draws(m_post, re_formula = NA)
  
```

```{r}
d_test %>% glimpse()
```


```{r}
CI_team_vary_natural <- function(d, ylim, xlim){
  
  # fitted means (draws for mean)
  d %>%
    group_by(condition_fct) %>%
    data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
              year_after_2005 = year_after_2005) %>% # fixed year
    add_epred_draws(m_post, re_formula = NA) %>% # ignore random effect
    ggplot(aes(x = exp(log_teamsize), y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    geom_jitter(data = d, alpha = 0.8) + 
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    labs(title = "", #  "Expected Value (mean actor)",
         x = "log(TEAMSIZE)",
         y = TeX("$c_5$")) +
    theme(plot.title = element_text(hjust = 0.5, size = title),
          axis.text = element_text(size = tick),
          axis.title = element_text(size = label),
          legend.text = element_text(size = tick),
          legend.position = "bottom") +
    scale_color_manual(
      values = c('#e6550d', '#fdae6b'),
      guide = guide_legend(title = NULL)) +
    scale_fill_manual(
      values = c('#e6550d', '#fdae6b'),
      guide = guide_legend(title = NULL)) +
    ylim(0, ylim) +
    xlim(0, xlim)
  
}
```

```{r}
max(d$n_authors)
```


```{r}

CI_team_vary_natural(d, 300, max(d$n_authors))

```

```{r}

CI_team_vary_natural(d, 150, 20)

```


TEAMSIZE draws (CI bands) marginalized study and mean YEAR (2010).

EXPLANATION:
Based on our fitted BETA values (population) and random-effects (group-level) variation
we plot the expected value based on a number of draws (and 95% and 80% confidence intervals). 
We marginalize over the random-effects of study (see McElreath & mjskay) and generalize
to new population??

```{r}

CI_team_marginalized <- function(d, ylim){
  
  # fitted means (marginalized)
  base_id = 2000
  levels <- nrow(d)/2
  max_id = base_id + levels - 1
  
  d %>%
    group_by(condition_fct) %>%
    data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
              id_match = as_factor(rep(base_id:max_id, each = 2)),
              year_after_2005 = min(year_after_2005)) %>% # fixed year (mean = 2010). 
    add_epred_draws(m_post, ndraws = 50, re_formula = NULL, allow_new_levels =TRUE) %>% # marginalize 
    ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
      stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
      geom_jitter(data = d) +
      scale_fill_brewer(palette = "Set2") +
      scale_color_brewer(palette = "Dark2") +
    ylim(0, ylim)
    
}
```

## DRAW THEM 

```{r}

draws_team_min(d, 300)

```

```{r}

CI_team_min(d, 500)

```

```{r}

CI_team_vary(d, 500)

```

```{r}

CI_team_marginalized(d, 1000)

```

### TEAMSIZE

#### kruschke-style 

```{r}

# fitted means (draws for mean)
d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            #id_match = id_match,
            year_after_2005 = mean(year_after_2005)) %>% # fixed year
  add_epred_draws(m_post, ndraws = 100, re_formula = NA) %>% # ignore random effects
  ggplot(aes(x = log_teamsize, y = c_5, color= ordered(condition_fct))) +
  geom_line(aes(y = .epred, group = paste(condition_fct, .draw)), alpha = 0.25) +
  geom_point(data = d) + 
  labs(title = "fitted draws (population estimate) for fixed year (mean) & ignore random effects") +
  ylim(0, 300)

```


Constant (mean) year & expectation from c5 mean study (random effects).

```{r}

# fitted means (draws for mean) and no re_formula (mean actor?)
d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            #id_match = id_match,
            year_after_2005 = mean(year_after_2005)) %>% # fixed year (year = 2010)
  add_epred_draws(m_post, re_formula = NA) %>% # ignore random effects
  ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    #stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    #geom_line(aes(y = .epred, group = paste(condition_fct, .draw)), alpha = 0.25) +
    geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 400)

```

Constant (mean) year & expectation for c5 marginalized (random effects) study. 

```{r}

# fitted means (marginalized)
base_id = 2000
levels <- nrow(d)/2
max_id = base_id + levels - 1

d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            id_match = as_factor(rep(base_id:max_id, each = 2)),
            year_after_2005 = mean(year_after_2005)) %>% # fixed year (mean = 2010). 
  add_epred_draws(m_post, ndraws = 50, re_formula = NULL, allow_new_levels =TRUE) %>% # marginalize 
  ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 1000)

```

predict (not quite same as above, but on the same scale). 

```{r}

# predicted draws
base_id = 2000
levels <- nrow(d)/2
max_id = base_id + levels - 1

d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = seq_range(log_teamsize, n = 101),
            id_match = as_factor(rep(base_id:max_id, each = 2)),
            year_after_2005 = mean(year_after_2005)) %>% # fixed year (mean = 2010). 
  add_predicted_draws(m_post, ndraws = 20, re_formula = NULL, allow_new_levels =TRUE) %>% # marginalize 
  ggplot(aes(x = log_teamsize, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    stat_lineribbon(aes(y = .prediction), .width = c(.95, .80), alpha = 1/4) +
    geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 1000)

```

### YEAR 

mean for mean study?

```{r}

# fitted means (draws for mean) and no re_formula (mean actor?)
d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = mean(log_teamsize),
            year_after_2005 = seq_range(year_after_2005, n = 101)) %>%
  add_epred_draws(m_post, re_formula = NA) %>% # ignore random effects
  ggplot(aes(x = year_after_2005, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    #geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 25)

```

```{r}

# fitted means (marginalized)
base_id = 2000
levels <- nrow(d)/2
max_id = base_id + levels - 1

d %>%
  group_by(condition_fct) %>%
  data_grid(log_teamsize = mean(log_teamsize),
            id_match = as_factor(rep(base_id:max_id, each = 2)),
            year_after_2005 = seq_range(year_after_2005, 101)) %>% # fixed year (mean = 2010). 
  add_epred_draws(m_post, ndraws = 50, re_formula = NULL, allow_new_levels =TRUE) %>% # marginalize 
  ggplot(aes(x = year_after_2005, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    #geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 100)

```


```{r}

## other varialbles at mean ##
d %>% 
  group_by(condition_fct) %>% 
  data_grid(log_teamsize = mean(log_teamsize),
            year_after_2005 = mean(year_after_2005)) %>%
  add_epred_draws(m_post, ndraws = 100, re_formula = NA) %>% # ignore random effects
  ggplot(aes(x = year_after_2005, y = c_5, color = ordered(condition_fct), fill = ordered(condition_fct))) +
    #stat_lineribbon(aes(y = .epred), .width = c(.95, .80), alpha = 1/4) +
    #geom_point(data = d) +
    scale_fill_brewer(palette = "Set2") +
    scale_color_brewer(palette = "Dark2") +
  ylim(0, 25)
## other variables at min (intercept)

  
```



